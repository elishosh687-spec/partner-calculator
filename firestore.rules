rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function - check if user is signed in
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Helper function - check if user is EcoBrothers (boss)
    function isBoss() {
      return isSignedIn() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'boss';
    }
    
    // Helper function - check if user is owner of document
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    // Rules for users collection
    match /users/{userId} {
      // Read: user themselves or EcoBrothers
      allow read: if isOwner(userId) || isBoss();
      
      // Create: only during registration (user creates their own document)
      allow create: if isOwner(userId) && 
                       request.resource.data.keys().hasAll(['name', 'email', 'role', 'createdAt']);
      
      // Update: only user themselves (cannot change role)
      allow update: if isOwner(userId) && 
                       request.resource.data.role == resource.data.role;
      
      // Delete: forbidden
      allow delete: if false;
    }
    
    // Rules for transactions collection
    match /transactions/{transactionId} {
      // Read: EcoBrothers sees all, partner sees only their own
      allow read: if isSignedIn() && 
                     (isBoss() || resource.data.partnerId == request.auth.uid);
      
      // Create: 
      // - EcoBrothers can create transaction for any partner (partnerId can be someone else's)
      // - Partner can create transaction only for themselves (partnerId must be theirs)
      // Support both old (shimonShare/shimonPercentage) and new (ecobrothersShare/ecobrothersPercentage) field names
      allow create: if isSignedIn() && 
                       (isBoss() || request.resource.data.partnerId == request.auth.uid) &&
                       request.resource.data.keys().hasAll([
                         'partnerId', 
                         'partnerName',
                         'customerName', 
                         'date', 
                         'totalRevenue', 
                         'totalExpenses',
                         'netProfit',
                         'eliShare',
                         'eliPercentage',
                         'createdAt'
                       ]) &&
                       // Must have either old or new field names for EcoBrothers share
                       (request.resource.data.keys().hasAny(['shimonShare', 'ecobrothersShare'])) &&
                       (request.resource.data.keys().hasAny(['shimonPercentage', 'ecobrothersPercentage'])) &&
                       // bossId and bossName are optional (for support of old transactions)
                       (!request.resource.data.keys().hasAny(['bossId']) || 
                        request.resource.data.keys().hasAll(['bossId', 'bossName']));
      
      // Update: 
      // - EcoBrothers can update any transaction and change partnerId/partnerName (for fixing old data)
      // - Transaction owner can update their transaction (but cannot change partnerId)
      allow update: if isSignedIn() && 
                       (isBoss() || 
                        (resource.data.partnerId == request.auth.uid && 
                         request.resource.data.partnerId == resource.data.partnerId));
      
      // Delete: transaction owner or EcoBrothers
      allow delete: if isSignedIn() && 
                       (resource.data.partnerId == request.auth.uid || isBoss());
    }
  }
}

